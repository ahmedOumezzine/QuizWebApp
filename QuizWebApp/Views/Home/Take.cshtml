@model IEnumerable<QuizWebApp.Models.Question>

@{
    ViewBag.Title = "Take";
}

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    <input name="ExamId" type="hidden" value="@ViewBag.ExamId" />

    foreach (var item in Model.Select((value, i) => new { i, value }))
    {

        <div class="col-sm-12">
            <input type="hidden" name="question[@item.i]" value="@item.value.Id">
            @item.value.QuestionDescription <br />
            @if (item.value.QuestionType == QuizWebApp.Models.QuestionType.FillInBlank)
            {
                <br />
                string razorCode = item.value.FillInBlank;
                string newRazorCode = "";
                int count = 0;
                int question = 0;

                for (int i = 0; i < razorCode.Length; i++)
                {
                    if (razorCode[i] == '{')
                    {
                        count++;
                        newRazorCode += "<select name=\"reponse[" + item.i + "][" + question + "]\" id=\"cars\">";
                    }
                    else if (razorCode[i] == '}')
                    {
                        count--;
                        newRazorCode += "}";
                    }
                    else
                    {
                        newRazorCode += razorCode[i];
                    }

                    if (count == 0 && newRazorCode.EndsWith("}"))
                    {
                        foreach (var Choice in item.value.Choices.Where(x => x.GroupBy == "question_" + question))
                        {
                            newRazorCode += "<option value= '" + @Choice.Id + "'   > " + Choice.ChoiceText + "</option>";
                        }
                        newRazorCode += "</select>";
                        question++;

                    }
                }

                @Html.Raw(newRazorCode)

            }
            @if (item.value.QuestionType == QuizWebApp.Models.QuestionType.SingleChoice || item.value.QuestionType == QuizWebApp.Models.QuestionType.TrueFalse)
            {
                foreach (var Choice in item.value.Choices)
                {
                    <input type="radio" id="Choice_@Choice.Id" name="reponse[@item.i]" value="@Choice.Id">
                    <label for="Choice_@Choice.Id">@Choice.ChoiceText</label>
                    <br />
                }
                <hr />
            }
            @if (item.value.QuestionType == QuizWebApp.Models.QuestionType.MultiChoice)
            {
                foreach (var Choice in item.value.Choices)
                {
                    <input type="checkbox" id="Choice_@Choice.Id" name="reponse[@item.i]" value="@Choice.Id">
                    <label for="Choice_@Choice.Id">@Choice.ChoiceText</label>
                    <br />
                }
                <hr />
            }

            @if (item.value.QuestionType == QuizWebApp.Models.QuestionType.DragAndDrop || item.value.QuestionType == QuizWebApp.Models.QuestionType.DragAndDrop2)
            {

                <div class="facet-container row">
                    <div class="left">
                        <label>All options</label>
                        <ul id="allFacets" class="facet-list">
                            @{
                                var rnd = new Random();
                            }

                            @foreach (var Choice in item.value.Choices.OrderBy(i => rnd.Next()).ToList())
                            {
                                <li class="facet" data-question="@item.i" data-value="@Choice.Id">
                                    @Choice.ChoiceText
                                    <input type="hidden" value="@Choice.Id">
                                </li>

                            }
                        </ul>
                    </div>
                    <div class="right">
                        <label>Your reponse</label>
                        <ul id="userFacets" class="facet-list">
                        </ul>
                    </div>
                </div>
                <hr />
            }
        </div>

    }

    <div class="form-group" style=" float: right; ">
        <input type="submit" value="Create" class="btn btn-primary" />
    </div>
}

@section Styles {

    <style>
        .facet-container {
            width: 330px;
        }

        .facet-list {
            list-style-type: none;
            margin: 0;
            padding: 0;
            margin-right: 10px;
            background: #eee;
            padding: 5px;
            width: 143px;
            min-height: 1.5em;
            font-size: 0.85em;
        }

            .facet-list li {
                margin: 5px;
                padding: 5px;
                font-size: 1.2em;
                width: 120px;
            }

                .facet-list li.placeholder {
                    height: 1.2em
                }

        .facet {
            border: 1px solid #bbb;
            background-color: #fafafa;
            cursor: move;
        }

            .facet.ui-sortable-helper {
                opacity: 0.5;
            }

        .placeholder {
            border: 1px solid orange;
            background-color: #fffffd;
        }
    </style>
}
@section Scripts {
    <script>
        $(function () {
            $("#allFacets, #userFacets").sortable({
                connectWith: "ul",
                placeholder: "placeholder",
                delay: 150,
                stop: function (event, ui) {
                    var li = ui.item.first();
                    var input = ui.item.find('input');

                    if (event.target.id === 'allFacets') {
                        let question = li.attr('data-question');
                        let value = li.attr('data-value');
                        input.attr('name', 'reponse[' + question + ']');

                    } else {
                        input.attr('name', '');

                    }
                }
            });
        });
    </script>
}